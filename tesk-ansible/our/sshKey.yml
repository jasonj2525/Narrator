[ssh]
172.18.18.120 ansible_ssh_user=root ansible_ssh_pass=123456

- hosts: ssh
  gather_facts: no
  tasks:
    - name: enforce env
      shell: source /etc/profile
      run_once: true
    - name: close ssh check #关闭初次访问提示询问
      shell: sed -i "s/^.*StrictHostKeyChecking.*$/ StrictHostKeyChecking no/g" /etc/ssh/ssh_config
    - name: delete /root/.ssh/
      file: path=/root/.ssh/ state=absent
    - name: generating public/private rsa key pair #生成公钥和私钥
      shell: ssh-keygen -t rsa -b 2048 -N '' -f /root/.ssh/id_rsa
    - name: view id_rsa.pub #将公钥设置成变量
      shell: cat /root/.ssh/id_rsa.pub
      register: sshinfo
    - set_fact: sshpub={{sshinfo.stdout}}
    - name: add ssh record #合并各个节点公钥
      local_action: shell echo {{sshpub}} >> {{AnsibleDir}}/roles/templates/authorized_keys.j2
    - name: copy authorized_keys.j2 to all #分发到各个节点上
      template: src={{AnsibleDir}}/roles/templates/authorized_keys.j2 dest=/root/.ssh/authorized_keys mode=0600
      tags:
       - install ssh
